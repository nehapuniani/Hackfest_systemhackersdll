/*
    *
    * Wijmo Library 5.20151.63
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    * 
    * Licensed under the Wijmo Commercial License. 
    * sales@wijmo.com
    * http://wijmo.com/products/wijmo-5/license/
    *
    */
var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},wijmo;(function(n){(function(t){"use strict";var i=function(t){function i(i,r,u){t.call(this);this._count=0;this._sortOnServer=!0;this._pageOnServer=!0;this._filterOnServer=!0;this._inferDataTypes=!0;this.loading=new n.Event;this.loaded=new n.Event;this.error=new n.Event;this._url=n.asString(i,!1);this._tbl=n.asString(r);u&&n.copy(this,u);this._getSchema();var f=this;this.sortDescriptions.collectionChanged.addHandler(function(){f.sortOnServer&&f._getData()})}return __extends(i,t),Object.defineProperty(i.prototype,"fields",{get:function(){return this._fields},set:function(t){this._fields!=t&&(this._fields=n.asArray(t),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keys",{get:function(){return this._keys},set:function(t){this._keys=n.asArray(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"dataTypes",{get:function(){return this._dataTypes},set:function(n){this._dataTypes=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"inferDataTypes",{get:function(){return this._inferDataTypes},set:function(t){this._inferDataTypes=n.asBoolean(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(t){t!=this._sortOnServer&&(this._sortOnServer=n.asBoolean(t),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(t){t!=this._pageOnServer&&(this._pageOnServer=n.asBoolean(t),this.pageSize&&this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(t){t!=this._filterOnServer&&(this._filterOnServer=n.asBoolean(t),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filterDefinition",{get:function(){return this._filterDef},set:function(t){t!=this._filterDef&&(this._filterDef=n.asString(t),this.sortOnServer&&this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"oDataVersion",{get:function(){return this._odv},set:function(t){this._odv=n.asNumber(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0}),i.prototype.onLoading=function(n){this.loading.raise(this,n)},i.prototype.onLoaded=function(n){this.loaded.raise(this,n)},i.prototype.onError=function(n){return this.error.raise(n),!n.cancel},i.prototype.commitNew=function(){var i=this.currentAddItem,r=this,u;i&&(u=this._getWriteUrl(),n.httpRequest(u,{method:"POST",data:this._stringifyNumbers(i),requestHeaders:{Accept:"application/json"},success:function(n){var t=JSON.parse(n.response);r.keys.forEach(function(n){i[n]=t[n]});r.refresh()},error:this._error.bind(this)}));t.prototype.commitNew.call(this)},i.prototype.commitEdit=function(){var i=this.currentEditItem,r;!i||this.currentAddItem||this._sameContent(i,this._edtClone)||(r=this._getWriteUrl(this._edtClone),n.httpRequest(r,{method:"PUT",data:this._stringifyNumbers(i),error:this._error.bind(this)}));t.prototype.commitEdit.call(this)},i.prototype.remove=function(i){if(i){var r=this._getWriteUrl(i);n.httpRequest(r,{method:"DELETE",error:this._error.bind(this)})}t.prototype.remove.call(this,i)},Object.defineProperty(i.prototype,"totalItemCount",{get:function(){return this._count},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pageSize",{get:function(){return this._pgSz},set:function(t){t!=this._pgSz&&(this._pgSz=n.asInt(t),this.pageOnServer?(this._pgIdx=n.clamp(this._pgIdx,0,this.pageCount-1),this._getData()):this.refresh())},enumerable:!0,configurable:!0}),i.prototype.onPageChanging=function(n){return t.prototype.onPageChanging.call(this,n),!n.cancel&&this.pageOnServer&&this._getData(),!n.cancel},i.prototype._getPageView=function(){return this.pageOnServer?this._view:t.prototype._getPageView.call(this)},i.prototype._performRefresh=function(){var n=this._canFilter,i=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;t.prototype._performRefresh.call(this);this._canFilter=n;this._canSort=i},i.prototype._stringifyNumbers=function(t){var r,u,i;if(this._odv>=4)return t;r={};for(u in t)i=t[u],r[u]=n.isNumber(i)?i.toString():i;return r},i.prototype._getReadUrl=function(n){var t=this._url;return t[t.length-1]!="/"&&(t+="/"),n?t=n.indexOf("http")==0?n:t+n:this._tbl&&(t+=this._tbl),t},i.prototype._getReadParams=function(n){var t={$format:"json"},i,r,u;if(this._tbl&&!n){if(this._odv<4?t.$inlinecount="allpages":t.$count=!0,this.fields&&(t.$select=this.fields.join(",")),this.sortOnServer&&this.sortDescriptions.length){for(i="",r=0;r<this.sortDescriptions.length;r++)u=this.sortDescriptions[r],i&&(i+=","),i+=u.property,u.ascending||(i+=" desc");t.$orderby=i}this.filterOnServer&&this.filterDefinition&&(t.$filter=this.filterDefinition);this.pageOnServer&&this.pageSize>0&&(t.$skip=this.pageIndex*this.pageSize,t.$top=this.pageSize)}return t},i.prototype._convertItem=function(t,i){var u,f,r;for(u in t)f=t[u],r=i[u],r!=undefined&&(f===4&&r&&r.indexOf("/Date(")==0&&(r=new Date(parseInt(r.substr(6)))),i[u]=n.changeType(r,f,null))},i.prototype._getInferredDataTypes=function(t){var u=null,f,r,e,o;if(t.length>0){for(f={},r=0;r<t.length&&r<10;r++)this._extend(f,t[r]);for(e in f)o=f[e],n.isString(o)&&o.match(i._rxDate)&&(u||(u={}),u[e]=4)}return u},i.prototype._getData=function(t){if(this._odv==null){this._getSchema();return}var i=this;i._toGetData&&clearTimeout(i._toGetData);i._toGetData=setTimeout(function(){i._loading=!0;i.onLoading();var r=i._getReadUrl(t);n.httpRequest(r,{data:i._getReadParams(t),success:function(n){var r=JSON.parse(n.response),u=r.d?r.d.results:r.value,o=r.d?r.d.__count:r["odata.count"]||r["odata.count"]||r["@odata.count"],e,f;if(o!=null&&(i._count=parseInt(o)),t||i.inferDataTypes&&!i._dataTypesInferred&&(i._dataTypesInferred=i._getInferredDataTypes(u)),e=i.dataTypes?i.dataTypes:i._dataTypesInferred,e)for(f=0;f<u.length;f++)i._convertItem(e,u[f]);t?Array.prototype.push.apply(i.sourceCollection,u):i.sourceCollection=u;i.refresh();t=r.d?r.d.__next:r["odata.nextLink"];t?i._getData(t):(i._loading=!1,i.onLoaded())},error:function(n){i._loading=!1;i.onLoaded();throw n.statusText;}})},100)},i.prototype._getServiceUrl=function(){var n=this._url;return n[n.length-1]!="/"&&(n+="/"),n},i.prototype._getSchema=function(){var t=this,r=t._getServiceUrl()+"/$metadata";t._odv=i._odvCache[r];this._odv?this._getData():n.httpRequest(r,{success:function(n){var u=n.response.match(/<.*Version\s*=\s*"(.*)"\s*>/i),f=u?parseFloat(u[1]):4;i._odvCache[r]=t._odv=f;t._getData()}})},i.prototype._getWriteUrl=function(t){var i=this._getServiceUrl(),r;return i+=this._tbl,t&&(n.assert(this.keys&&this.keys.length>0,"write operations require keys."),r=[],this.keys.forEach(function(i){n.assert(t[i]!=null,"key values cannot be null.");r.push(i+"="+t[i])}),i+="("+r.join(",")+")"),i},i.prototype._error=function(t){var i=new n.RequestErrorEventArgs(t);if(this.onError(i)){this._getData();throw"HttpRequest Error: "+t.status+" "+t.statusText;}},i._odvCache={},i._rxDate=/^(\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)\/)$/,i}(n.collections.CollectionView);t.ODataCollectionView=i})(n.odata||(n.odata={}));var t=n.odata})(wijmo||(wijmo={}))